{% extends "base.html" %}
{% load static %}

{% block content %}
<style>
    .directions-container {
        padding: 40px 0;
        background: linear-gradient(136deg, #f8f9fa 0%, #e9ecef 100%);
        min-height: 100vh;
    }

    .directions-card {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        padding: 40px;
        margin: 20px auto;
        max-width: 1000px;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .back-link {
        color: #dc3545;
        text-decoration: none;
        font-weight: 600;
        font-size: 1.1rem;
        transition: all 0.3s ease;
    }

    .back-link:hover {
        color: #b02a37;
        text-decoration: none;
        transform: translateX(-5px);
    }

    .directions-title {
        font-size: 2.5rem;
        font-weight: 700;
        color: #2c3e50;
        text-align: center;
        margin-bottom: 30px;
        text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.1);
    }

    .route-summary {
        background: linear-gradient(135deg, #a83c32, #ea9066);
        color: white;
        padding: 25px;
        border-radius: 12px;
        text-align: center;
        margin-bottom: 30px;
        box-shadow: 0 8px 25px rgba(168, 60, 50, 0.3);
    }

    .route-info {
        display: flex;
        justify-content: space-around;
        flex-wrap: wrap;
        gap: 20px;
    }

    .info-item {
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .info-item i {
        font-size: 2rem;
        margin-bottom: 10px;
        color: rgba(255, 255, 255, 0.9);
    }

    .info-value {
        font-size: 1.8rem;
        font-weight: 700;
        margin-bottom: 5px;
    }

    .info-label {
        font-size: 0.9rem;
        opacity: 0.9;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .route-details {
        background: rgba(255, 255, 255, 0.9);
        border-radius: 12px;
        padding: 30px;
        border-left: 5px solid #ea9066;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
        margin-bottom: 30px;
    }

    .route-details h3 {
        color: #50302c;
        font-weight: 600;
        margin-bottom: 20px;
        font-size: 1.6rem;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .directions-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .direction-step {
        display: flex;
        align-items: flex-start;
        padding: 15px 0;
        border-bottom: 1px solid #e9ecef;
        transition: all 0.3s ease;
    }

    .direction-step:last-child {
        border-bottom: none;
    }

    .direction-step:hover {
        background: rgba(168, 60, 50, 0.05);
        border-radius: 8px;
        padding-left: 10px;
    }

    .step-number {
        background: #a83c32;
        color: white;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        margin-right: 15px;
        flex-shrink: 0;
        font-size: 0.9rem;
    }

    .step-text {
        flex: 1;
        color: #555;
        line-height: 1.6;
        font-size: 1rem;
    }

    .map-container {
        height: 400px;
        width: 100%;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        margin-top: 20px;
    }

    .error-message {
        background: linear-gradient(135deg, #f8d7da, #f5c6cb);
        border: 2px solid #f5c6cb;
        border-radius: 12px;
        padding: 25px;
        color: #721c24;
        text-align: center;
        margin: 20px 0;
        box-shadow: 0 5px 15px rgba(220, 53, 69, 0.1);
    }

    .error-message i {
        font-size: 2rem;
        margin-bottom: 15px;
        display: block;
    }

    .try-again-btn {
        background: linear-gradient(45deg, #dc3545, #c82333);
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-block;
        margin-top: 15px;
    }

    .try-again-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(220, 53, 69, 0.4);
        color: white;
        text-decoration: none;
    }

    @media (max-width: 768px) {
        .directions-card {
            padding: 20px;
            margin: 10px;
        }

        .directions-title {
            font-size: 2rem;
        }

        .route-info {
            flex-direction: column;
            text-align: center;
        }

        .info-item {
            margin-bottom: 15px;
        }

        .route-details {
            padding: 20px;
        }

        .route-details h3 {
            font-size: 1.4rem;
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;
        }
    }
</style>

<div class="directions-container">
    <div class="container">
        <div class="mb-4">
            <a href="{% url 'learnmore' event.id %}" class="back-link">
                <i class="fas fa-arrow-left me-2"></i>Back 
            </a>
        </div>

        <div class="directions-card">
            <h1 class="directions-title">
                <i class="fas fa-route me-3" style="color: #ea9066;"></i>
                Directions
            </h1>

            {% if error_message %}
                <div class="error-message">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h4>Unable to Get Directions</h4>
                    <p>{{ error_message }}</p>
                    <a href="{% url 'learnmore' event.id %}" class="try-again-btn">
                        <i class="fas fa-redo me-2"></i>Try Again
                    </a>
                </div>
            {% else %}
                <div class="route-summary">
                    <div class="route-info">
                        <div class="info-item">
                            <i class="fas fa-road"></i>
                            <div class="info-value">{{ distance_km }} km</div>
                            <div class="info-label">Distance</div>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-clock"></i>
                            <div class="info-value">{{ duration_minutes }} min</div>
                            <div class="info-label">Duration</div>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-{{ travel_mode_icon }}"></i>
                            <div class="info-value">{{ travel_mode_display }}</div>
                            <div class="info-label">Mode</div>
                        </div>
                    </div>
                </div>

                {% if has_location %}
                    <div class="route-details">
                        <h3>
                            <i class="fas fa-map" style="color: #ea9066;"></i>
                            Route Map
                        </h3>
                        <div id="directions-map" class="map-container"></div>
                    </div>
                {% endif %}
            {% endif %}
        </div>
    </div>
</div>

{% if has_location and not error_message %}
    {{ map_style_url|json_script:"map-style-data" }}
    {{ start_coordinates|json_script:"start-coordinates" }}
    {{ destination_coordinates|json_script:"destination-coordinates" }}
    {{ encoded_polyline|json_script:"encoded-polyline" }}

    <script>
        // Polyline decoding function
        function decodePolyline(encoded) {
            if (!encoded) return [];
            
            let points = [];
            let index = 0;
            let lat = 0;
            let lng = 0;
            
            while (index < encoded.length) {
                let b;
                let shift = 0;
                let result = 0;
                
                do {
                    b = encoded.charCodeAt(index++) - 63;
                    result |= (b & 0x1f) << shift;
                    shift += 5;
                } while (b >= 0x20);
                
                let dlat = ((result & 1) !== 0 ? ~(result >> 1) : (result >> 1));
                lat += dlat;
                
                shift = 0;
                result = 0;
                
                do {
                    b = encoded.charCodeAt(index++) - 63;
                    result |= (b & 0x1f) << shift;
                    shift += 5;
                } while (b >= 0x20);
                
                let dlng = ((result & 1) !== 0 ? ~(result >> 1) : (result >> 1));
                lng += dlng;
                
                points.push([lng / 1e5, lat / 1e5]);
            }
            
            return points;
        }

        // Initialize directions map
        var mapStyleUrl = JSON.parse(document.getElementById('map-style-data').textContent);
        var startCoords = JSON.parse(document.getElementById('start-coordinates').textContent);
        var destCoords = JSON.parse(document.getElementById('destination-coordinates').textContent);
        var encodedPolyline = JSON.parse(document.getElementById('encoded-polyline').textContent);

        var map = new mapboxgl.Map({
            container: "directions-map",
            style: mapStyleUrl,
            center: [destCoords.lon, destCoords.lat],
            zoom: 12,
            attributionControl: false
        });

        map.on('load', function() {
            // Add markers
            new mapboxgl.Marker({ color: '#28a745' })
                .setLngLat([startCoords.lon, startCoords.lat])
                .setPopup(new mapboxgl.Popup().setHTML('<strong>Start:</strong> {{ start_address }}'))
                .addTo(map);

            new mapboxgl.Marker({ color: '#dc3545' })
                .setLngLat([destCoords.lon, destCoords.lat])
                .setPopup(new mapboxgl.Popup().setHTML('<strong>Destination:</strong> {{ site.name }}'))
                .addTo(map);

            // Decode and add the route polyline
            if (encodedPolyline) {
                var routeCoordinates = decodePolyline(encodedPolyline);
                
                if (routeCoordinates.length > 0) {
                    // Add the route source
                    map.addSource('route', {
                        'type': 'geojson',
                        'data': {
                            'type': 'Feature',
                            'properties': {},
                            'geometry': {
                                'type': 'LineString',
                                'coordinates': routeCoordinates
                            }
                        }
                    });

                    // Add the route layer
                    map.addLayer({
                        'id': 'route',
                        'type': 'line',
                        'source': 'route',
                        'layout': {
                            'line-join': 'round',
                            'line-cap': 'round'
                        },
                        'paint': {
                            'line-color': '#ea9066',
                            'line-width': 6,
                            'line-opacity': 0.8
                        }
                    });

                    // Add a subtle outline for the route
                    map.addLayer({
                        'id': 'route-outline',
                        'type': 'line',
                        'source': 'route',
                        'layout': {
                            'line-join': 'round',
                            'line-cap': 'round'
                        },
                        'paint': {
                            'line-color': '#a83c32',
                            'line-width': 8,
                            'line-opacity': 0.5
                        }
                    }, 'route');

                    // Fit map to show the entire route
                    var bounds = new mapboxgl.LngLatBounds();
                    routeCoordinates.forEach(coord => bounds.extend(coord));
                    map.fitBounds(bounds, { padding: 50 });
                } else {
                    // Fallback: fit map to show both markers if polyline decoding fails
                    var bounds = new mapboxgl.LngLatBounds();
                    bounds.extend([startCoords.lon, startCoords.lat]);
                    bounds.extend([destCoords.lon, destCoords.lat]);
                    map.fitBounds(bounds, { padding: 50 });
                }
            } else {
                // Fallback: fit map to show both markers if no polyline
                var bounds = new mapboxgl.LngLatBounds();
                bounds.extend([startCoords.lon, startCoords.lat]);
                bounds.extend([destCoords.lon, destCoords.lat]);
                map.fitBounds(bounds, { padding: 50 });
            }
        });
    </script>
{% endif %}

{% endblock content %}