<!-- templates/sites/nearby_places.html -->
{% extends "base.html" %}
{% load static %}

{% block content %}
<style>
    .nearby-container {
        padding: 40px 0;
        background: linear-gradient(135deg, #f5ede6 0%, #ece6df 100%);
        min-height: 100vh;
    }

    .nearby-card {
        background: linear-gradient(135deg, #fffaf6 0%, #f9f5f0 100%);
        border-radius: 20px;
        box-shadow: 0 8px 30px rgba(185,74,58,0.08);
        margin: 20px auto;
        max-width: 1400px;
        border: 1px solid #ece6df;
        overflow: hidden;
        backdrop-filter: blur(10px);
    }

    .back-link {
        color: #b94a3a;
        text-decoration: none;
        font-weight: 600;
        font-size: 1.1rem;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        margin-bottom: 20px;
        padding: 10px 20px;
        background: #fffaf6;
        border-radius: 25px;
        border: 2px solid #e2b07b;
        box-shadow: 0 2px 8px rgba(185,74,58,0.08);
    }

    .back-link:hover {
        background: #b94a3a;
        color: #fff;
        text-decoration: none;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(185,74,58,0.15);
    }

    .nearby-header {
        background: linear-gradient(135deg, #b94a3a 0%, #b45309 100%);
        color: white;
        padding: 40px;
        text-align: center;
        position: relative;
        overflow: hidden;
    }

    .nearby-header::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 200px;
        height: 200px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 50%;
        transform: translate(50px, -50px);
    }

    .nearby-title {
        font-size: 2.5rem;
        font-weight: 700;
        margin: 0 0 15px 0;
        text-shadow: 1px 1px 3px rgba(108,46,34,0.2);
        position: relative;
        z-index: 2;
    }

    .nearby-subtitle {
        font-size: 1.2rem;
        opacity: 0.9;
        margin: 0 0 10px 0;
        position: relative;
        z-index: 2;
    }

    .nearby-description {
        font-size: 1rem;
        opacity: 0.8;
        margin: 0;
        position: relative;
        z-index: 2;
    }

    .content-wrapper {
        display: flex;
        min-height: 70vh;
    }

    .sidebar {
        width: 400px;
        padding: 30px;
        background: linear-gradient(135deg, #fffaf6 0%, #f5ede6 100%);
        border-right: 2px solid #ece6df;
        overflow-y: auto;
        max-height: 70vh;
    }

    .places-count {
        background: linear-gradient(135deg, #b94a3a 0%, #b45309 100%);
        color: white;
        padding: 20px;
        border-radius: 15px;
        text-align: center;
        margin-bottom: 25px;
        font-weight: 700;
        font-size: 1.1rem;
        box-shadow: 0 4px 15px rgba(185,74,58,0.15);
        border: 1px solid rgba(255,255,255,0.1);
    }

    .place-item {
        background: linear-gradient(135deg, #fffaf6 0%, #f9f5f0 100%);
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 15px;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 2px solid #ece6df;
        box-shadow: 0 4px 12px rgba(185,74,58,0.05);
        border-left: 5px solid #e2b07b;
        position: relative;
        overflow: hidden;
    }

    .place-item::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(45deg, transparent 30%, rgba(226,176,123,0.02) 50%, transparent 70%);
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .place-item:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(185,74,58,0.12);
        border-color: #e2b07b;
        border-left-color: #b94a3a;
    }

    .place-item:hover::before {
        opacity: 1;
    }

    .place-item.selected {
        border-color: #b94a3a;
        border-left-color: #b94a3a;
        transform: translateY(-3px);
        box-shadow: 0 10px 25px rgba(185,74,58,0.18);
        background: linear-gradient(135deg, #f9f5f0 0%, #f3c892 100%);
    }

    .place-name {
        font-weight: 700;
        margin-bottom: 10px;
        color: #6c2e22;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        gap: 8px;
        position: relative;
        z-index: 2;
    }

    .place-name i {
        color: #e2b07b;
        font-size: 1rem;
    }

    .place-address {
        color: #8c7c6b;
        font-size: 0.95rem;
        margin-bottom: 12px;
        line-height: 1.5;
        display: flex;
        align-items: flex-start;
        gap: 8px;
        position: relative;
        z-index: 2;
    }

    .place-address i {
        color: #b94a3a;
        margin-top: 2px;
    }

    .place-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 12px;
        position: relative;
        z-index: 2;
    }

    .meta-item {
        background: #ece6df;
        color: #6c2e22;
        padding: 6px 12px;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 5px;
        border: 1px solid #e2b07b;
    }

    .meta-item i {
        font-size: 0.7rem;
    }

    .distance {
        background: linear-gradient(45deg, #b94a3a, #e2b07b);
        color: white;
        border-color: #b94a3a;
    }

    .open-status {
        background: linear-gradient(45deg, #6c2e22, #8c7c6b);
        color: white;
        border-color: #6c2e22;
    }

    .closed-status {
        background: linear-gradient(45deg, #b94a3a, #8c3a2b);
        color: white;
        border-color: #b94a3a;
    }

    .type-tag {
        background: linear-gradient(45deg, #e2b07b, #f3c892);
        color: #6c2e22;
        border-color: #e2b07b;
    }

    .phone-tag {
        background: linear-gradient(45deg, #b45309, #e2b07b);
        color: white;
        border-color: #b45309;
    }

    #map {
        flex: 1;
        min-height: 70vh;
        border-radius: 0 0 20px 0;
    }

    .no-places {
        text-align: center;
        padding: 60px 20px;
        color: #8c7c6b;
        background: linear-gradient(135deg, #fffaf6 0%, #f5ede6 100%);
        border-radius: 15px;
        border: 2px dashed #ece6df;
    }

    .no-places i {
        font-size: 4rem;
        color: #e2b07b;
        margin-bottom: 20px;
        display: block;
    }

    .no-places h4 {
        color: #6c2e22;
        margin-bottom: 15px;
        font-weight: 600;
    }

    .error-message {
        background: linear-gradient(135deg, #f3c892 0%, #ece6df 100%);
        border: 2px solid #e2b07b;
        border-radius: 15px;
        padding: 40px;
        color: #6c2e22;
        text-align: center;
        margin: 40px;
        box-shadow: 0 8px 20px rgba(185,74,58,0.08);
    }

    .error-message i {
        font-size: 3rem;
        margin-bottom: 20px;
        display: block;
        color: #b94a3a;
    }

    .try-again-btn {
        background: linear-gradient(45deg, #b94a3a, #b45309);
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 25px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        margin-top: 15px;
        box-shadow: 0 4px 12px rgba(185,74,58,0.15);
    }

    .try-again-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(185,74,58,0.25);
        color: white;
        text-decoration: none;
        background: linear-gradient(45deg, #b45309, #e2b07b);
    }

    /* Custom scrollbar for sidebar */
    .sidebar::-webkit-scrollbar {
        width: 6px;
    }

    .sidebar::-webkit-scrollbar-track {
        background: #ece6df;
        border-radius: 3px;
    }

    .sidebar::-webkit-scrollbar-thumb {
        background: #b94a3a;
        border-radius: 3px;
    }

    .sidebar::-webkit-scrollbar-thumb:hover {
        background: #8c3a2b;
    }

    @media (max-width: 1024px) {
        .content-wrapper {
            flex-direction: column;
        }

        .sidebar {
            width: 100%;
            max-height: 400px;
            border-right: none;
            border-bottom: 2px solid #ece6df;
        }

        #map {
            min-height: 400px;
            border-radius: 0 0 20px 20px;
        }
    }

    @media (max-width: 768px) {
        .nearby-card {
            margin: 10px;
            border-radius: 15px;
        }

        .nearby-header {
            padding: 30px 20px;
        }

        .nearby-title {
            font-size: 2rem;
        }

        .sidebar {
            padding: 20px;
        }

        .place-item {
            padding: 15px;
        }

        .back-link {
            padding: 8px 16px;
            font-size: 1rem;
        }

        .places-count {
            padding: 15px;
            font-size: 1rem;
        }
    }

    /* Enhanced map controls styling */
    .mapboxgl-ctrl-group {
        border-radius: 8px !important;
        box-shadow: 0 2px 8px rgba(185,74,58,0.08) !important;
    }

    .mapboxgl-ctrl button {
        border-radius: 6px !important;
    }

    /* Enhanced popup styling */
    .mapboxgl-popup-content {
        border-radius: 12px !important;
        box-shadow: 0 4px 15px rgba(185,74,58,0.15) !important;
        border: 1px solid #ece6df !important;
    }

    .mapboxgl-popup-tip {
        border-top-color: #fffaf6 !important;
    }
</style>

<div class="nearby-container">
    <div class="container">
        <a href="{% url 'site_detail' site.id %}" class="back-link">
            <i class="fas fa-arrow-left me-2"></i>Back to {{ site.name }}
        </a>

        <div class="nearby-card">
            <div class="nearby-header">
                <h1 class="nearby-title">
                    <i class="fas fa-map-marker-alt me-3"></i>
                    {{ place_info.title }}
                </h1>
                <p class="nearby-subtitle">Around {{ site.name }}</p>
                <p class="nearby-description">{{ place_info.description }}</p>
            </div>

            {% if not has_location %}
                <div class="error-message">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h4>Location Not Available</h4>
                    <p>Unable to find coordinates for this site. Please ensure the site has a valid map address.</p>
                    <a href="{% url 'site_detail' site.id %}" class="try-again-btn">
                        <i class="fas fa-redo me-2"></i>Back to Site
                    </a>
                </div>
            {% else %}
                <div class="content-wrapper">
                    <div class="sidebar">
                        <div class="places-count">
                            <i class="fas fa-search me-2"></i>
                            Found {{ places|length }} {{ place_type }}
                        </div>

                        {% for place in places %}
                        <div class="place-item" data-index="{{ forloop.counter0 }}" data-lon="{{ place.lon }}" data-lat="{{ place.lat }}">
                            <div class="place-name">
                                <i class="fas fa-store"></i>
                                {{ place.name }}
                            </div>
                            <div class="place-address">
                                <i class="fas fa-map-marker-alt"></i>
                                {{ place.address }}
                            </div>

                            <div class="place-meta">
                                <span class="meta-item type-tag">
                                    <i class="fas fa-tag"></i>
                                    {{ place.type|title }}
                                </span>
                                {% if place.distance != 'N/A' %}
                                <span class="meta-item distance">
                                    <i class="fas fa-road"></i>
                                    {{ place.distance|floatformat:1 }} km
                                </span>
                                {% endif %}
                                {% if place.open is not None %}
                                    {% if place.open %}
                                    <span class="meta-item open-status">
                                        <i class="fas fa-clock"></i>
                                        Open
                                    </span>
                                    {% else %}
                                    <span class="meta-item closed-status">
                                        <i class="fas fa-clock"></i>
                                        Closed
                                    </span>
                                    {% endif %}
                                {% endif %}
                                {% if place.phone %}
                                <span class="meta-item phone-tag">
                                    <i class="fas fa-phone"></i>
                                    {{ place.phone }}
                                </span>
                                {% endif %}
                            </div>
                        </div>
                        {% empty %}
                        <div class="no-places">
                            <i class="fas fa-search"></i>
                            <h4>No {{ place_type }} found nearby</h4>
                            <p>Try expanding the search radius or check back later for updated results.</p>
                        </div>
                        {% endfor %}
                    </div>

                    <div id="map"></div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

{% if has_location %}
    {{ map_style_url|json_script:"map-style-data" }}
    {{ coordinates|json_script:"site-coordinates" }}
    {{ BAATO_API_KEY|json_script:"baato-api-key" }}

    {{ places|json_script:"places-data" }}
    
    <script>
        document.querySelectorAll('.place-item').forEach((item, index) => {
    item.addEventListener('click', function() {
        const lon = parseFloat(this.dataset.lon);
        const lat = parseFloat(this.dataset.lat);
        const itemIndex = parseInt(this.dataset.index);
        selectPlace(lon, lat, itemIndex);
    });
});
        // Initialize map with Baato style
        var mapStyleUrl = JSON.parse(document.getElementById('map-style-data').textContent);
        var siteCoords = JSON.parse(document.getElementById('site-coordinates').textContent);
        var baatoApiKey = JSON.parse(document.getElementById('baato-api-key').textContent);
        var placesData = JSON.parse(document.getElementById('places-data').textContent);
        var siteName = document.querySelector('.nearby-subtitle').textContent.replace('Around ', '');

        // Use Mapbox GL JS with Baato style
        mapboxgl.accessToken = baatoApiKey; // Using Baato token temporarily

        const map = new mapboxgl.Map({
            container: 'map',
            style: mapStyleUrl,
            center: [siteCoords.lon, siteCoords.lat],
            zoom: 12,
            attributionControl: false
        });

        // Add custom attribution
        map.addControl(new mapboxgl.AttributionControl({
            customAttribution: 'Map data Â© Baato'
        }));

        // Places data from template
        const places = placesData;
        let markers = [];
        let selectedIndex = -1;

        map.on('load', function() {
            // Add main site marker with custom styling
            const siteMarker = new mapboxgl.Marker({ 
                color: '#a83c32', 
                scale: 1.3 
            })
            .setLngLat([siteCoords.lon, siteCoords.lat])
            .setPopup(new mapboxgl.Popup({ 
                offset: 25,
                className: 'site-popup'
            }).setHTML(`
                <div style="text-align: center; padding: 10px;">
                    <strong style="color: #a83c32; font-size: 16px;">${siteName}</strong><br>
                    <small style="color: #6c757d;">Main Site Location</small>
                </div>
            `))
            .addTo(map);

            // Add place markers with enhanced popups
            places.forEach((place, index) => {
                const popupContent = `
                    <div style="padding: 10px; max-width: 250px;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <i class="fas fa-store" style="color: #ea9066;"></i>
                            <strong style="color: #2c3e50; font-size: 15px;">${place.name}</strong>
                        </div>
                        <div style="display: flex; align-items: flex-start; gap: 6px; margin-bottom: 8px; color: #6c757d; font-size: 13px;">
                            <i class="fas fa-map-marker-alt" style="color: #a83c32; margin-top: 2px;"></i>
                            <span>${place.address}</span>
                        </div>
                        <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                            <span style="background: #e9ecef; padding: 2px 8px; border-radius: 10px; font-size: 11px; color: #495057;">
                                <i class="fas fa-tag" style="font-size: 9px;"></i> ${place.type}
                            </span>
                            ${place.distance !== 'N/A' ? 
                                `<span style="background: #a83c32; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px;">
                                    <i class="fas fa-road" style="font-size: 9px;"></i> ${parseFloat(place.distance).toFixed(1)} km
                                </span>` : ''}
                            ${place.open !== null ? 
                                `<span style="background: ${place.open ? '#28a745' : '#dc3545'}; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px;">
                                    <i class="fas fa-clock" style="font-size: 9px;"></i> ${place.open ? 'Open' : 'Closed'}
                                </span>` : ''}
                            ${place.phone ? 
                                `<span style="background: #17a2b8; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px;">
                                    <i class="fas fa-phone" style="font-size: 9px;"></i> ${place.phone}
                                </span>` : ''}
                        </div>
                    </div>
                `;

                const marker = new mapboxgl.Marker({ 
                    color: '#28a745',
                    scale: 0.9
                })
                .setLngLat([place.lon, place.lat])
                .setPopup(new mapboxgl.Popup({ 
                    offset: 25,
                    className: 'place-popup'
                }).setHTML(popupContent))
                .addTo(map);

                markers.push(marker);
            });

            // Fit map to show all markers
            if (places.length > 0) {
                const bounds = new mapboxgl.LngLatBounds();
                
                // Add main site
                bounds.extend([siteCoords.lon, siteCoords.lat]);
                
                // Add all places
                places.forEach(place => {
                    bounds.extend([place.lon, place.lat]);
                });
                
                // Fit map to bounds with padding
                map.fitBounds(bounds, { 
                    padding: { top: 50, bottom: 50, left: 420, right: 50 } // Account for sidebar
                });
            }
        });

        // Function to select a place (now using event delegation)
        function selectPlace(lon, lat, index) {
            // Remove previous selection
            document.querySelectorAll('.place-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // Add selection to new item
            document.querySelectorAll('.place-item')[index].classList.add('selected');
            selectedIndex = index;
            
            // Center map on selected place with smooth animation
            map.flyTo({
                center: [lon, lat],
                zoom: 16,
                duration: 1200,
                essential: true
            });
            
            // Show popup for selected marker
            if (markers[index]) {
                markers[index].togglePopup();
            }
        }

        // Add event listeners to place items
        document.querySelectorAll('.place-item').forEach((item, index) => {
            item.addEventListener('click', function() {
                const lon = parseFloat(this.dataset.lon);
                const lat = parseFloat(this.dataset.lat);
                const itemIndex = parseInt(this.dataset.index);
                selectPlace(lon, lat, itemIndex);
            });
        });

        // Add navigation controls
        map.addControl(new mapboxgl.NavigationControl());

        // Add fullscreen control
        map.addControl(new mapboxgl.FullscreenControl());

        // Add geolocate control
        map.addControl(new mapboxgl.GeolocateControl({
            positionOptions: {
                enableHighAccuracy: true
            },
            trackUserLocation: true,
            showUserHeading: true
        }));
    </script>
{% endif %}

{% endblock content %}