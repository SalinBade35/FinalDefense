{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
<link rel="stylesheet" href="{% static 'css/delivery_style.css' %}">
{% endblock %}

{% block content %}
<div class="container main-container">
    <div class="checkout-container">
        <div class="row">
            <!-- Order Summary Section -->
            <div class="col-lg-5">
                <div class="section-card order-summary-card sticky-order-summary" data-aos="fade-right">
                    <div class="card-header">
                        <h2>
                            <i data-feather="shopping-bag"></i>
                            Order Summary
                        </h2>
                        <p>Review your selected items</p>
                    </div>
                    <div class="card-body">
                        <!-- Order Items -->
                        {% for item in cart_items %}
                        <div class="order-item">
                            <div class="item-details">
                                <h5>{{ item.product.name }}</h5>
                                <p>{{ item.product.description|truncatechars:50 }}</p>
                            </div>
                            <div class="item-price">
                                <div class="price">${{ item.total_price|floatformat:2 }}</div>
                                <div class="quantity">Qty: {{ item.quantity }}</div>
                                <div class="unit-price">${{ item.product.price|floatformat:2 }} each</div>
                            </div>
                        </div>
                        {% endfor %}
                        
                        <!-- Total Section -->
                        <div class="total-section">
                            <div class="total-row">
                                <span>Subtotal:</span>
                                <span>${{ total_amount|floatformat:2 }}</span>
                            </div>
                            <div class="total-row">
                                <span>Delivery:</span>
                                <span>Free</span>
                            </div>
                            <div class="total-row">
                                <span>Total:</span>
                                <span>${{ total_amount|floatformat:2 }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Customer Information Section -->
            <div class="col-lg-7">
                <form id="codForm" action="{% url 'souvenirs:process_delivery_order' %}" method="POST">
                    {% csrf_token %}
                    {% if direct_buy %}
                        <input type="hidden" name="direct_buy" value="1">
                        <input type="hidden" name="direct_buy_product" value="{{ cart_items.0.product.id }}">
                        <input type="hidden" name="direct_buy_qty" value="{{ cart_items.0.quantity }}">
                    {% endif %}
                    
                    <!-- Customer Information -->
                    <div class="section-card customer-info-card" data-aos="fade-left">
                        <div class="card-header">
                            <h2>
                                <i data-feather="user"></i>
                                Customer Information
                            </h2>
                            <p>Please provide your contact and delivery details</p>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="firstName" class="form-label">First Name*</label>
                                    <input type="text" id="firstName" name="firstName" required class="form-control">
                                </div>
                                <div class="col-md-6">
                                    <label for="lastName" class="form-label">Last Name*</label>
                                    <input type="text" id="lastName" name="lastName" required class="form-control">
                                </div>
                            </div>

                            <div class="mt-3">
                                <label for="email" class="form-label">Email Address*</label>
                                <input type="email" 
                                    id="email" 
                                    name="email" 
                                    required 
                                    class="form-control"
                                    pattern="[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}"
                                    title="Please enter a valid email address"
                                    placeholder="example@email.com">
                                <div class="invalid-feedback" id="emailError">
                                    Please enter a valid email address.
                                </div>
                            </div>

                            <div class="mt-3">
                                <label for="phone" class="form-label">Phone Number*</label>
                                <div class="input-group">
                                    <span class="input-group-text">+977</span>
                                    <input type="tel" 
                                        id="phone" 
                                        name="phone" 
                                        required 
                                        class="form-control"
                                        pattern="^(98[0-9]{8}|01-[0-9]{7})$"
                                        title="Enter valid Nepal phone number (Mobile: 98XXXXXXXX or Landline: 01-XXXXXXX)"
                                        placeholder="98XXXXXXXX"
                                        maxlength="10">
                                </div>
                            </div>

                            <div class="mt-4">
                                <label for="address" class="form-label">Delivery Address*</label>
                                <textarea id="address" name="address" rows="3" required class="form-control" placeholder="Ward number, Tole/Street name, House/Building details..."></textarea>
                                <small class="form-text text-muted">Example: Ward 10, Dattatreya Square, Near Peacock Window</small>
                            </div>

                            <div class="row g-3 mt-1">
                                <div class="col-md-4">
                                    <label for="city" class="form-label">City*</label>
                                    <input type="text" id="city" name="city" required class="form-control" value="Bhaktapur" readonly>
                                </div>
                                <div class="col-md-4">
                                    <label for="state" class="form-label">Province*</label>
                                    <select id="state" name="state" required class="form-select">
                                        <option value="">Select Province</option>
                                        <option value="Bagmati" selected>Bagmati Province</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="zip" class="form-label">Ward Number*</label>
                                    <select id="zip" name="zip" required class="form-select">
                                        <option value="">Select Ward</option>
                                        <option value="44800-01">Ward 1 (44800)</option>
                                        <option value="44800-02">Ward 2 (44800)</option>
                                        <option value="44800-03">Ward 3 (44800)</option>
                                        <option value="44800-04">Ward 4 (44800)</option>
                                        <option value="44800-05">Ward 5 (44800)</option>
                                        <option value="44800-06">Ward 6 (44800)</option>
                                        <option value="44800-07">Ward 7 (44800)</option>
                                        <option value="44800-08">Ward 8 (44800)</option>
                                        <option value="44800-09">Ward 9 (44800)</option>
                                        <option value="44800-10">Ward 10 (44800)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Delivery Instructions -->
                    <div class="section-card delivery-instructions-card" data-aos="fade-left" data-aos-delay="100">
                        <div class="card-header">
                            <h2>
                                <i data-feather="truck"></i>
                                Delivery Instructions
                            </h2>
                            <p>Optional preferences for your delivery</p>
                        </div>
                        <div class="card-body">
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="callBefore" name="callBefore">
                                <label class="form-check-label" for="callBefore">
                                    Call me before delivery
                                </label>
                            </div>
                            <div class="form-check mb-4">
                                <input class="form-check-input" type="checkbox" id="leaveAtDoor" name="leaveAtDoor">
                                <label class="form-check-label" for="leaveAtDoor">
                                    Leave at door if I'm not available
                                </label>
                            </div>
                            <div>
                                <label for="specialInstructions" class="form-label">Special Instructions</label>
                                <textarea id="specialInstructions" name="specialInstructions" rows="3" class="form-control" placeholder="Any special delivery instructions..."></textarea>
                            </div>
                            
                            <div class="form-actions">
                                <a href="{% url 'souvenirs:souvenir_list' %}" class="back-link">
                                    <i data-feather="arrow-left"></i> Back to souvenirs
                                </a>
                                <button type="submit" class="btn submit-btn" id="codSubmitBtn">
                                    Complete Order
                                    <i data-feather="check"></i>
                                </button>
                            </div> 
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
<script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
<script src="{% static 'js/delivery.js' %}"></script>
{% endblock %}