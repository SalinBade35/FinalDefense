{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<link rel="stylesheet" href="{% static 'css/product_detail.css' %}">
{% endblock %}

{% block content %}
<div class="container my-4">
    <!-- Back Button -->
    <div class="mb-3">
        <a href="{% url 'souvenirs:souvenir_list' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back to Products
        </a>
    </div>
    
    <!-- Product Container -->
    <div class="product-container">
        <div class="row g-0">
            <!-- Product Image -->
            <div class="col-lg-6 p-4">
                <img src="{% if product.image %}{{ product.image.url }}{% elif product.image_url %}{{ product.image_url }}{% else %}https://via.placeholder.com/500x500?text=Product+Image{% endif %}" 
                    alt="{{ product.name }}" 
                    class="product-image"
                    onerror="this.src='https://via.placeholder.com/500x500?text=Product+Image'">
            </div>

            <!-- Product Info -->
            <div class="col-lg-6 p-4">
                <h1 class="product-title">{{ product.name }}</h1>
                
                <!-- Rating -->
                <div class="product-rating">
                    <div class="stars" id="avg-stars">
                        <!-- Stars will be rendered by JS -->
                    </div>
                    <span class="rating-text" id="avg-rating-text">(0/5) â€¢ 0 reviews</span>
                </div>

                <!-- Review Submission Form (for logged-in users) -->
                {% if user.is_authenticated %}
                <div id="review-form-section" class="mt-4">
                    <h4>Leave a Review</h4>
                    <form id="reviewForm">
                        <div class="mb-2">
                            <label for="rating">Rating:</label>
                            <select id="rating" name="rating" required>
                                <option value="">Select</option>
                                {% for i in "12345" %}
                                <option value="{{ i }}">{{ i }} Star{{ i|pluralize }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-2">
                            <label for="comment">Comment:</label>
                            <textarea id="comment" name="comment" class="form-control" rows="2"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Submit Review</button>
                        <div id="review-message" class="mt-2"></div>
                    </form>
                </div>
                {% else %}
                <div class="alert alert-info mt-4">
                    <a href="{% url 'log_in' %}?next={{ request.path }}">Log in</a> to leave a review.
                </div>
                {% endif %}

                <!-- Reviews List -->
                <div id="reviews-section" class="mt-4">
                    <h4>Customer Reviews</h4>
                    <div id="reviews-list"></div>
                </div>

                <!-- Price -->
                <div class="product-pricing mb-3">
                    <div class="current-price">${{ product.price }}</div>
                    {% if product.has_discount %}
                        <div class="pricing-details">
                            <span class="original-price">${{ product.original_price }}</span>
                            <span class="discount-badge">{{ product.discount_percentage }}% OFF</span>
                            <div class="savings-info">You save ${{ product.savings_amount }}</div>
                        </div>
                    {% endif %}
                </div>

                <!-- Description -->
                <p class="product-description">{{ product.description }}</p>

                <!-- Stock Status -->
                {% if is_in_stock %}
                    <div class="stock-badge in-stock">
                        <i class="fas fa-check-circle me-1"></i>{{ product.in_stock }} items in stock
                    </div>
                {% else %}
                    <div class="stock-badge out-of-stock">
                        <i class="fas fa-times-circle me-1"></i>Out of stock
                    </div>
                {% endif %}

                <!-- Quantity Section (only if in stock) -->
                {% if is_in_stock %}
                    <div class="quantity-section">
                        <label class="form-label fw-bold mb-2">Quantity:</label>
                        <div class="quantity-controls">
                            <button class="quantity-btn" onclick="decreaseQuantity()">
                                <i class="fas fa-minus"></i>
                            </button>
                            <input type="number" id="quantity" class="quantity-input" value="1" min="1" max="{{ product.in_stock }}">
                            <button class="quantity-btn" onclick="increaseQuantity()">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="action-buttons">
                        <form id="buyNowForm" method="get" action="{% url 'souvenirs:delivery' %}" class="d-inline">
                            <input type="hidden" name="product" value="{{ product.id }}">
                            <input type="hidden" name="qty" id="buyNowQty" value="1">
                            <button type="submit" class="btn btn-buy">
                                <i class="fas fa-bolt me-2"></i>Buy Now
                            </button>
                        </form>
                        <button class="btn btn-cart add-to-cart-btn" data-product-id="{{ product.id }}">
                            <i class="fas fa-shopping-cart me-2"></i>Add to Cart
                        </button>
                        <button class="btn btn-wishlist add-to-wishlist-btn" data-product-id="{{ product.id }}">
                            <i class="far fa-heart"></i>
                        </button>
                    </div>
                {% else %}
                    <!-- Out of Stock Actions -->
                    <div class="action-buttons">
                        <button class="btn btn-secondary flex-fill" disabled>
                            <i class="fas fa-ban me-2"></i>Currently Unavailable
                        </button>
                        <button class="btn btn-wishlist add-to-wishlist-btn" data-product-id="{{ product.id }}">
                            <i class="far fa-heart"></i>
                        </button>
                    </div>
                {% endif %}

                <!-- Success Alert -->
                <div class="alert-custom alert-success" id="successAlert">
                    <i class="fas fa-check-circle"></i>
                    <span id="alertMessage">Action completed successfully!</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="{% static 'js/main.js' %}"></script>
<script src="{% static 'js/product_detail.js' %}"></script>
<script>
    // Set window variables for cart functionality
    window.isAuthenticated = {{ user.is_authenticated|yesno:"true,false" }};
    window.loginUrl = "{% url 'log_in' %}";
</script>
{% endblock %}